---
name: "Test"
on:
  pull_request:
  push:
    branches:
      - "main"
jobs:
  tox:
    name: "Test ${{ matrix.toxenv }}"
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        toxenv:
          - "3.14t"
          - "3.14"
    steps:
      - name: "Check out repository"
        uses: "actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd" # v6.0.2
      - name: "Install uv"
        uses: "astral-sh/setup-uv@61cb8a9741eeb8a550a1b8544337180c0fc8476b" # v7.2.0
      - name: "Install OS packages"
        run: |
          sudo apt-get --quiet update
          sudo apt-get install --quiet --yes build-essential libxml2-dev libxslt1-dev
      - name: "Start integration services"
        run: |
          docker compose up --detach --wait --wait-timeout 180 --no-deps aipscan-mysql
      - name: "Run tox"
        run: make test TOXENV="${{ matrix.toxenv }}" PYTESTARGS="--cov AIPscan --cov-config .coveragerc --cov-report xml:coverage.xml"
      - name: "Upload coverage report"
        if: ${{ github.repository == 'artefactual-labs/AIPscan' && !contains(github.event.head_commit.message, '[skip codecov]') && !contains(github.event.head_commit.message, '[skip-codecov]') }}
        uses: "codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de" # v5.5.2
        env:
          CODECOV_TOKEN: "${{ secrets.CODECOV_TOKEN }}"
        with:
          files: ./coverage.xml
          fail_ci_if_error: true
          verbose: true
          name: ${{ matrix.toxenv }}
          flags: ${{ matrix.toxenv }}
      - name: "Stop integration services"
        if: ${{ always() }}
        run: |
          docker compose down --volumes
  lint:
    name: "Lint"
    runs-on: ubuntu-24.04
    steps:
      - name: "Check out repository"
        uses: "actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd" # v6.0.2
      - name: "Install uv"
        uses: "astral-sh/setup-uv@61cb8a9741eeb8a550a1b8544337180c0fc8476b" # v7.2.0
      - name: "Run linters"
        run: make lint
  migration-check:
    name: "Migration drift"
    runs-on: ubuntu-24.04
    steps:
      - name: "Check out repository"
        uses: "actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd" # v6.0.2
      - name: "Start MySQL"
        run: docker compose up --detach --wait --wait-timeout 180 --no-deps aipscan-mysql
      - name: "Upgrade and check migrations"
        run: docker compose run --rm --no-deps aipscan-migrate bash -c "flask db upgrade && flask db check"
      - name: "Tear down services"
        if: ${{ always() }}
        run: docker compose down --volumes
